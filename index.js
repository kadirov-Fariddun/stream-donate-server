import express from "express";
import mysql from "mysql2";
import cors from 'cors';
import multer from 'multer';
const app = express();
const PORT = 5000;

app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

const db = mysql.createConnection({
    host: "localhost",
    user: "root",
    password: "",
    database: "donate",
    port: 3306
})


// Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÐÐ´Ð¼Ð¸Ð½Ð°
app.get('/api/admin', (req, res) => {
    db.query('SELECT * FROM `admin`', (err, results) => {
        if (err) {
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°:', err);
            return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
        }

        res.json(results); // Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ
    });
});
// Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
app.get('/api/users', (req, res) => {
    db.query('SELECT * FROM `users`', (err, results) => {
        if (err) {
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°:', err);
            return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
        }

        res.json(results); // Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ ÐºÐ»Ð¸Ðµ
    });
});

app.get('/api/users/:name', (req, res) => {
    const { name } = req.params;

    const query = 'SELECT * FROM users WHERE name = ?';
    db.query(query, [name], (err, results) => {
        if (err) {
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°:', err);
            return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
        }

        if (results.length === 0) {
            return res.status(404).json({ error: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½' });
        }

        res.json(results[0]); // Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    });
});


// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° multer Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² Ð¿Ð°Ð¼ÑÑ‚ÑŒ
const storage = multer.memoryStorage();
const upload = multer({ storage: storage });

// POST-Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÐµÐ¼
app.post("/api/users/create", upload.single("image"), (req, res) => {
    const { name, description } = req.body;
    const image = req.file?.buffer;

    if (!name || !image) {
        return res.status(400).json({ error: "Name, description Ð¸ image Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹." });
    }

    const query = "INSERT INTO users (name, description, image) VALUES (?, ?, ?)";
    db.query(query, [name, description, image], (err, result) => {
        if (err) {
            console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²ÑÑ‚Ð°Ð²ÐºÐµ Ð² Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…:", err);
            return res.status(500).json({ error: "ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð° Ð¿Ñ€Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ" });
        }
        res.json({ message: "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½", id: result.insertId });
    });
});
// ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ 
app.delete("/api/users/delete/:id", (req, res) => {
    const userId = req.params.id;

    if (!userId) {
        return res.status(400).json({ error: "ID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð½Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½" });
    }

    const query = "DELETE FROM users WHERE id = ?";
    
    db.query(query, [userId], (err, result) => {
        if (err) {
            console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:", err);
            return res.status(500).json({ error: "ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ" });
        }

        if (result.affectedRows === 0) {
            return res.status(404).json({ error: "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½" });
        }

        res.json({ success: true, message: "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½" });
    });
});


//Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ»Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
app.get('/api/wallets', (req, res) => {
    const username = req.query.name;

    if (!username) {
        return res.status(400).json({ error: 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ Ð¸Ð¼Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ' });
    }

    db.query('SELECT * FROM `wallets` WHERE `name` = ?', [username], (err, results) => {
        if (err) {
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°:', err);
            return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
        }

        res.json(results);
    });
});
app.get('/api/wallets/:name', (req, res) => {
    const { name } = req.params;

    const query = 'SELECT * FROM wallets WHERE name = ?';
    db.query(query, [name], (err, results) => {
        if (err) {
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°:', err);
            return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
        }

        if (results.length === 0) {
            return res.status(404).json({ error: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½' });
        }

        res.json(results); // Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    });
});


// ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ¾ÑˆÐµÐ»ÑŒÐºÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ 
app.post('/api/wallets/create', (req, res) => {
    const { name, wallet_adress, crypto_name, ids } = req.body;

    if (!name || !wallet_adress || !crypto_name || !ids) {
        return res.status(400).json({ error: 'ÐÐµ Ð²ÑÐµ Ð¿Ð¾Ð»Ñ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹' });
    }

    const query = 'INSERT INTO `wallets` (name, wallet_adress, crypto_name, ids) VALUES (?, ?, ?, ?)';
    const values = [name, wallet_adress, crypto_name, ids];

    db.query(query, values, (err, result) => {
        if (err) {
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ ÐºÐ¾ÑˆÐµÐ»ÑŒÐºÐ°:', err);
            return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
        }

        res.json({ success: true, message: 'ÐšÐ¾ÑˆÐµÐ»ÐµÐº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½' });
    });
});

// ÑƒÐ´Ð°Ð»ÐµÐ¼ ÐºÐ¾ÑˆÐµÐ»ÐµÐº Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
app.delete('/api/wallets/delete/:id', (req, res) => {
    const walletId = req.params.id;

    if (!walletId) {
        return res.status(400).json({ error: 'ID ÐºÐ¾ÑˆÐµÐ»ÑŒÐºÐ° Ð½Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½' });
    }

    const query = 'DELETE FROM `wallets` WHERE id = ?';
    
    db.query(query, [walletId], (err, result) => {
        if (err) {
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ ÐºÐ¾ÑˆÐµÐ»ÑŒÐºÐ°:', err);
            return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
        }

        if (result.affectedRows === 0) {
            return res.status(404).json({ error: 'ÐšÐ¾ÑˆÐµÐ»ÐµÐº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½' });
        }

        res.json({ success: true, message: 'ÐšÐ¾ÑˆÐµÐ»ÐµÐº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½' });
    });
});

// Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµÑ… ÑÐ¿Ð¸ÑÐ¾Ðº Ð´Ð¾Ð½Ð°Ñ‚ÐµÑ€Ð¾Ð² 
app.get('/api/donaters', (req, res) => {

    db.query('SELECT * FROM `donaters`', (err, results) => {
        if (err) {
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°:', err);
            return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
        }

        res.json(results);
    });
});

// ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð´Ð¾Ð½Ð°Ñ‚ÐµÑ€Ð° 
// POST: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð´Ð¾Ð½Ð°Ñ‚ÐµÑ€Ð°
app.post('/api/donaters/create', (req, res) => {
    const { username, price, message, type } = req.body;

    if (!username || !price || !type) {
        return res.status(400).json({ error: 'ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ: username, price, type' });
    }

    const date = new Date().toLocaleString('ru-RU', {
        timeZone: 'Europe/Moscow', // Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½Ð° Ð´Ñ€ÑƒÐ³ÑƒÑŽ Ð·Ð¾Ð½Ñƒ
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });

    const query = 'INSERT INTO donaters (username, price, message, date, type) VALUES (?, ?, ?, ?, ?)';
    const values = [username, price, message || '', date, type];

    db.query(query, values, (err, result) => {
        if (err) {
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð´Ð¾Ð½Ð°Ñ‚ÐµÑ€Ð°:', err);
            return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
        }

        res.json({ success: true, message: 'Ð”Ð¾Ð½Ð°Ñ‚ÐµÑ€ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½', date });
    });
});



app.listen(PORT, () => {
    console.log(`ðŸš€ Server is running at http://localhost:${PORT}`);
});
